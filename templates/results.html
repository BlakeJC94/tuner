{% extends "base.html" %}

{% block title %}Tuner{% endblock %}

{% block content %}

<script>
    let currentAudio = null;
    let currentButton = null;

    function playPreview(url, button) {
        // If the same button is clicked, toggle playback
        if (currentAudio && currentButton === button) {
            if (currentAudio.paused) {
                currentAudio.play();
                button.textContent = "⏸";
            } else {
                currentAudio.pause();
                button.textContent = "⏵";
            }
            return;
        }

        // Stop any currently playing audio
        if (currentAudio) {
            currentAudio.pause();
            currentButton.textContent = "⏵"; // Reset the previous button text
        }

        // Create a new audio object and play it
        currentAudio = new Audio(url);
        currentAudio.play();

        // Update the button text and state
        currentButton = button;
        button.textContent = "⏸";

        // Reset button text when playback ends
        currentAudio.onended = () => {
            button.textContent = "⏵";
            currentAudio = null;
            currentButton = null;
        };
    }
</script>
<section class="center-justify">
    <h1>Your Music Match</h1>
</section>
<section class="center-justify">
    <div class="container">
        <!-- Matching Profile Section -->
        <section class="center-justify">
            <h2>
                You matched with {{ match.name }} ({{ match.score }}%)
            </h2>
        </section>

        <!-- Images Section -->
        <div class="image-gallery">
            {% for url in match.image_urls %}
            <div class="image-container">
                <img src="{{ url }}" alt="Related Image" />
            </div>
            {% endfor %}
        </div>

        <!-- Common Genres Section -->
        <div class="section">
            <h2>Common Genres</h2>
            <ul>
                {% for genre in match.common_genres %}
                <li>{{ genre }}</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Common Artists Section -->
        <div class="section">
            <h2>Common Artists</h2>
            <ul>
                {% for artist in match.common_artists %}
                <li>{{ artist }}</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Recommended Artists Section -->
        {% if match.recommended_artists %}
        <div class="section">
            <h2>Artists You May Like</h2>
            <ul>
                {% for artist in match.recommended_artists %}
                <li>{{ artist }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Playlist suggestion -->
        <h2>Spotify Playlist</h2>
        {% if match.playlist_data %}
        <p style="text-align: center;">
            Playlist created: <a href="{{ match.playlist_data.external_url }}">{{ match.playlist_data.name }}</a>
        </p>
        {% endif %}
        <table class="playlist-table">
            <thead>
                <tr>
                    <th>Preview</th>
                    <th>Image</th>
                    <th>Track</th>
                    <th>Artist</th>
                    <th>Album</th>
                </tr>
            </thead>
            <tbody>
                {% for track in match.tracks %}
                <tr>
                    <td style="vertical-align: middle;text-align: center;">
                        <button class="preview-btn" onclick="playPreview('{{ track.preview_url }}', this)"
                            {% if not track.preview_url %}disabled{% endif %}>
                            ⏵
                        </button>
                    </td>
                    <td><img src="{{ track.image_url }}" alt="{{ track.name }} cover" class="track-image"></td>
                    <td>{{ track.name }}</td>
                    <td>{{ track.artists }}</td>
                    <td>{{ track.album }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if not match.playlist_data %}
    <form action="/results" method="POST">
        <button type="submit" class="btn">Add playlist to Spotify</button>
    </form>
    {% endif %}
</section>
<section class="center-justify">
    <div class="donation-section">
        <p style="text-align: center;">If you enjoyed this service and want to support it, consider buying me a coffee :)</p>
        <form action="https://www.paypal.com/donate" method="post" target="_blank">
            <input type="hidden" name="business" value="blakejamescook@gmail.com">
            <input type="hidden" name="no_recurring" value="0">
            <input type="hidden" name="currency_code" value="USD">
            <input type="hidden" name="item_name" value="Support Tuner Development">
            <button type="submit" style="background-color: #0070ba; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                Donate
            </button>
        </form>
    </div>
</section>

{% endblock %}
